<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${move.id} != null ? 'Editar Mudanza' : 'Nueva Mudanza'">Mudanza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/components/formAuth.css}" />
    <link rel="stylesheet" th:href="@{/css/global/index.css}" />
    <script src="https://kit.fontawesome.com/936221bb7d.js" crossorigin="anonymous"></script>
</head>
<body>
<main>

    <div th:replace="components/navbar :: navbar"></div>

    <section class="container-custom my-5">
        <div class="container">
            <h2 th:text="${move.id} != null ? 'Editar Mudanza' : 'Nueva Mudanza'"></h2>
            <hr/>

            <form th:object="${move}"
                  th:action="${move.id} != null ? @{/movings/edit/{id}(id=${move.id})} : @{/movings}"
                  method="post">

                <div class="mb-3">
                    <label class="form-label">Fecha y hora</label>
                    <input th:field="*{movingDateTime}" type="datetime-local" class="form-control" required/>
                </div>

                <!-- COTIZACIÓN -->
                <!-- En nuevo select -->
                <div class="mb-3" th:if="${move.id == null}">
                    <label class="form-label">Cotización</label>
                    <select th:field="*{cotization.id}" class="form-select" required>
                        <option value="" disabled th:selected="${move.cotization == null}">
                            Selecciona cotización
                        </option>
                        <option th:each="c : ${cotizations}"
                                th:value="${c.id}"
                                th:text="${#temporals.format(c.requestedDate,'yyyy-MM-dd')
                               + ' | '
                               + c.originAddress
                               + ' → '
                               + c.destinationAddress
                               + ' | '
                               + c.client.name
                               + ' '
                               + c.client.surname}">
                        </option>
                    </select>
                </div>

                <!-- muestro datos en solo lectura -->
                <div class="mb-3" th:if="${move.id != null}">
                    <label class="form-label">Cotización</label>
                    <input type="hidden" th:field="*{cotization.id}" />
                    <input type="text" class="form-control mt-1"
                           th:value="${move.cotization.client.name} + ' ' + ${move.cotization.client.surname}"
                           disabled/>
                    <input type="text" class="form-control"
                           th:value="${move.cotization.originAddress} + ' → ' +
                     ${move.cotization.destinationAddress}"
                           disabled/>
                    <input type="text" class="form-control mt-1"
                           th:value="${move.cotization.price}"
                           disabled/>
                </div>

                <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <select th:field="*{state}" class="form-select" required>
                        <option th:each="st : ${states}"
                                th:value="${st}"
                                th:text="${st}">
                        </option>
                    </select>
                </div>

                <!-- Asignaciones -->
                <div class="mb-3" th:if="${move.id != null}">
                    <label class="form-label" th:if="${move.id != null}">Asignaciones</label>

                    <!-- Recorro cada vehículo de la cotización -->
                    <div th:each="veh, iterStat : ${move.cotization.vehicles}"
                         class="row g-2 mb-2">

                        <!-- hidden para enviar vehicle.id fijo -->
                        <input type="hidden"
                               th:field="*{transporters[__${iterStat.index}__].vehicle.id}" />

                        <!-- Muestro el vehículo (no editable) -->
                        <div class="col-md-6">
                            <input type="text"
                                   class="form-control"
                                   th:value="${veh.brand} + ' ' + ${veh.model}"
                                   disabled />
                        </div>

                        <!-- Select para el transportista -->
                        <div class="col-md-6">
                            <select class="form-select"
                                    th:field="*{transporters[__${iterStat.index}__].transporter.id}"
                                    required>
                                <option value="">Selecciona transportista</option>
                                <option th:each="t : ${transporters}"
                                        th:value="${t.id}"
                                        th:text="${t.name + ' ' + t.surname}">
                                </option>
                            </select>
                        </div>

                    </div>
                </div>


                 <!--Template oculto para nuevas filas -->
                <template id="assignment-template">
                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <select name="transporters[__idx__].transporter.id" class="form-select" required>
                                <option value="">Selecciona transportista</option>
                                <option th:each="t : ${transporters}"
                                        th:value="${t.id}"
                                        th:text="${t.name + ' ' + t.surname}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select name="transporters[__idx__].vehicle.id" class="form-select" required>
                                <option value="">Selecciona vehículo</option>
                                <option th:each="v : ${vehicles}"
                                        th:value="${v.id}"
                                        th:text="${v.brand + ' ' + v.model}">
                                </option>
                            </select>
                        </div>
                    </div>
                </template>

                <button type="submit" class="btn btn-primary me-2"
                        th:text="${move.id} != null ? 'Actualizar' : 'Crear'">Guardar</button>
                <a th:href="@{/movings}" class="btn btn-secondary">Cancelar</a>
            </form>
        </div>
    </section>
</main>

<div th:replace="components/footer :: footer"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let assignIndex = 1;

    function addAssignmentRow() {
        const tpl = document.getElementById('assignment-template').innerHTML;
        const html = tpl.replace(/__idx__/g, assignIndex);
        document.getElementById('assignments-container')
            .insertAdjacentHTML('beforeend', html);
        assignIndex++;
        updateDisableOptions();
    }

    function updateDisableOptions() {
        const tSelects = Array.from(document.querySelectorAll('select[name$=".transporter.id"]'));
        const chosenT = tSelects.map(s => s.value).filter(v => v);
        tSelects.forEach(sel => {
            sel.querySelectorAll('option').forEach(opt => {
                opt.disabled = opt.value && chosenT.includes(opt.value) && sel.value !== opt.value;
            });
        });

        const vSelects = Array.from(document.querySelectorAll('select[name$=".vehicle.id"]'));
        const chosenV = vSelects.map(s => s.value).filter(v => v);
        vSelects.forEach(sel => {
            sel.querySelectorAll('option').forEach(opt => {
                opt.disabled = opt.value && chosenV.includes(opt.value) && sel.value !== opt.value;
            });
        });
    }

    document.addEventListener('change', e => {
        if (e.target.matches('select[name$=".transporter.id"], select[name$=".vehicle.id"]')) {
            updateDisableOptions();
        }
    });
    document.addEventListener('DOMContentLoaded', updateDisableOptions);
</script>
</body>
</html>
