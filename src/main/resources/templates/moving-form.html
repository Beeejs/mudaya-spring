<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${move.id} != null ? 'Editar Mudanza' : 'Nueva Mudanza'">Mudanza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/components/formAuth.css}" />
    <link rel="stylesheet" th:href="@{/css/global/index.css}" />
    <script src="https://kit.fontawesome.com/936221bb7d.js" crossorigin="anonymous"></script>
</head>
<body>
<main>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/}">MUDAYA</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" th:href="@{/}">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/clients}">Clientes</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/vehicles}">Vehículos</a></li>
                    <li class="nav-item"><a class="nav-link active" th:href="@{/movings}">Mudanzas</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/signout}"><i class="fas fa-sign-out-alt"></i> Salir</a></li>
                </ul>
                <span class="navbar-text text-light">
          <i class="fas fa-user"></i> [[${session.currentUser.name}]]
        </span>
            </div>
        </div>
    </nav>

    <section class="container-custom my-5">
        <div class="container">
            <h2 th:text="${move.id} != null ? 'Editar Mudanza' : 'Nueva Mudanza'"></h2>
            <hr/>

            <form th:object="${move}"
                  th:action="${move.id} != null ? @{/movings/edit/{id}(id=${move.id})} : @{/movings}"
                  method="post">

                <div class="mb-3">
                    <label class="form-label">Fecha y hora</label>
                    <input th:field="*{movingDateTime}" type="datetime-local" class="form-control" required/>
                </div>

                <div class="mb-3">
                    <label class="form-label">Cotización</label>
                    <select th:field="*{cotization.id}" class="form-select" required>
                        <option th:each="c : ${cotizations}"
                                th:value="${c.id}"
                                th:text="${#temporals.format(c.requestedDate,'yyyy-MM-dd') + ' | ' + c.originAddress + ' → ' + c.destinationAddress}">
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <select th:field="*{state}" class="form-select" required>
                        <option th:each="st : ${states}"
                                th:value="${st}"
                                th:text="${st}">
                        </option>
                    </select>
                </div>

                <!-- Asignaciones (la primera fila, índice 0) -->
                <div class="mb-3">
                    <label class="form-label">Asignaciones</label>
                    <div class="row g-2" id="assignments-container">
                        <div class="col-md-6">
                            <select name="transporters[0].transporter.id" class="form-select" required>
                                <option value="">Selecciona transportista</option>
                                <option th:each="t : ${transporters}"
                                        th:value="${t.id}"
                                        th:text="${t.name + ' ' + t.surname}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select name="transporters[0].vehicle.id" class="form-select" required>
                                <option value="">Selecciona vehículo</option>
                                <option th:each="v : ${vehicles}"
                                        th:value="${v.id}"
                                        th:text="${v.brand + ' ' + v.model}">
                                </option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-link" onclick="addAssignmentRow()">
                        <i class="fas fa-plus"></i> Agregar asignación
                    </button>
                </div>

                <!-- Template oculto para nuevas filas -->
                <template id="assignment-template">
                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <select name="transporters[__idx__].transporter.id" class="form-select" required>
                                <option value="">Selecciona transportista</option>
                                <option th:each="t : ${transporters}"
                                        th:value="${t.id}"
                                        th:text="${t.name + ' ' + t.surname}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select name="transporters[__idx__].vehicle.id" class="form-select" required>
                                <option value="">Selecciona vehículo</option>
                                <option th:each="v : ${vehicles}"
                                        th:value="${v.id}"
                                        th:text="${v.brand + ' ' + v.model}">
                                </option>
                            </select>
                        </div>
                    </div>
                </template>

                <button type="submit" class="btn btn-primary me-2"
                        th:text="${move.id} != null ? 'Actualizar' : 'Crear'">Guardar</button>
                <a th:href="@{/movings}" class="btn btn-secondary">Cancelar</a>
            </form>
        </div>
    </section>
</main>

<div th:replace="components/footer :: footer"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let assignIndex = 1;

    function addAssignmentRow() {
        const tpl = document.getElementById('assignment-template').innerHTML;
        const html = tpl.replace(/__idx__/g, assignIndex);
        document.getElementById('assignments-container')
            .insertAdjacentHTML('beforeend', html);
        assignIndex++;
        updateDisableOptions();
    }

    function updateDisableOptions() {
        const tSelects = Array.from(document.querySelectorAll('select[name$=".transporter.id"]'));
        const chosenT = tSelects.map(s => s.value).filter(v => v);
        tSelects.forEach(sel => {
            sel.querySelectorAll('option').forEach(opt => {
                opt.disabled = opt.value && chosenT.includes(opt.value) && sel.value !== opt.value;
            });
        });

        const vSelects = Array.from(document.querySelectorAll('select[name$=".vehicle.id"]'));
        const chosenV = vSelects.map(s => s.value).filter(v => v);
        vSelects.forEach(sel => {
            sel.querySelectorAll('option').forEach(opt => {
                opt.disabled = opt.value && chosenV.includes(opt.value) && sel.value !== opt.value;
            });
        });
    }

    document.addEventListener('change', e => {
        if (e.target.matches('select[name$=".transporter.id"], select[name$=".vehicle.id"]')) {
            updateDisableOptions();
        }
    });
    document.addEventListener('DOMContentLoaded', updateDisableOptions);
</script>
</body>
</html>
